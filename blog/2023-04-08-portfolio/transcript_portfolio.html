<html><head><style>
html{font-family:sans-serif;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}body{margin:0}h1{margin:.67em 0;font-size:2em}pre{font-family:monospace,serif;font-size:1em}pre{white-space:pre-wrap}table{border-collapse:collapse;border-spacing:0}@media print{*{color:#000!important;text-shadow:none!important;background:transparent!important;box-shadow:none!important}pre{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr{page-break-inside:avoid}@page{margin:2cm .5cm}p,h2,h3{orphans:3;widows:3}h2,h3{page-break-after:avoid}.table td,.table th{background-color:#fff!important}.table{border-collapse:collapse!important}}*,*:before,*:after{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html{font-size:62.5%;-webkit-tap-highlight-color:rgba(0,0,0,0)}body{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-size:14px;line-height:1.428571429;color:#333;background-color:#fff}p{margin:0 0 10px}.text-right{text-align:right}h1,h2,h3{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-weight:500;line-height:1.1}h1,h2,h3{margin-top:20px;margin-bottom:10px}h1{font-size:36px}h2{font-size:30px}h3{font-size:24px}pre{font-family:Monaco,Menlo,Consolas,"Courier New",monospace}pre{display:block;padding:9.5px;margin:0 0 10px;font-size:13px;line-height:1.428571429;color:#333;word-break:break-all;word-wrap:break-word;background-color:#f5f5f5;border:1px solid #ccc;border-radius:4px}.container{padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}.container:before,.container:after{display:table;content:" "}.container:after{clear:both}.container:before,.container:after{display:table;content:" "}.container:after{clear:both}.row{margin-right:-15px;margin-left:-15px}.row:before,.row:after{display:table;content:" "}.row:after{clear:both}.row:before,.row:after{display:table;content:" "}.row:after{clear:both}@media(min-width:768px){.container{max-width:750px}}@media(min-width:992px){.container{max-width:970px}}@media(min-width:1200px){.container{max-width:1170px}}table{max-width:100%;background-color:transparent}th{text-align:left}.table{width:100%;margin-bottom:20px}.table thead>tr>th,.table tbody>tr>td{padding:8px;line-height:1.428571429;vertical-align:top;border-top:1px solid #ddd}.table thead>tr>th{vertical-align:bottom;border-bottom:2px solid #ddd}.table thead:first-child tr:first-child th{border-top:0}.table-striped>tbody>tr:nth-child(odd)>td{background-color:#f9f9f9}@-ms-viewport{width:device-width}@media screen and (max-width:400px){@-ms-viewport{width:320px}}</style></head><body>
<div class="container">
<div class=row><h1>portfolio_quicktest script and data</h1></div>
<div class="row">
<h2>Input files</h2>
<h3>Accounts</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">account_id</th><th class="text-right">earliest_period_start</th></thead><tbody>
<tr><td>ARKK</td><td>2020-12-31</td></tr>
<tr><td>ARKW</td><td>2020-12-31</td></tr>
<tr><td>ARKF</td><td>2020-12-31</td></tr>
<tr><td>ARKQ</td><td>2020-12-31</td></tr>
<tr><td>ARKG</td><td>2020-12-31</td></tr>
<tr><td>ARKX</td><td>2020-12-31</td></tr>
</tbody></table>
<p>Total 6 rows</p>
<h3>Transactions</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">ts</th><th class="text-right">account_id</th><th class="text-right">ticker</th><th class="text-right">qty</th><th class="text-right">price</th></thead><tbody>
<tr><td>2020-10-16</td><td>ARKK</td><td>TSLA</td><td>2466031</td><td>439.67</td></tr>
<tr><td>2020-10-20</td><td>ARKK</td><td>TSLA</td><td>18992</td><td>421.94</td></tr>
<tr><td>2020-10-21</td><td>ARKK</td><td>TSLA</td><td>2374</td><td>422.64</td></tr>
<tr><td>2020-10-22</td><td>ARKK</td><td>TSLA</td><td>7122</td><td>425.79</td></tr>
<tr><td>2020-10-23</td><td>ARKK</td><td>TSLA</td><td>7122</td><td>420.63</td></tr>
<tr><td>2020-10-27</td><td>ARKK</td><td>TSLA</td><td>1187</td><td>424.68</td></tr>
<tr><td>2020-10-28</td><td>ARKK</td><td>TSLA</td><td>4748</td><td>406.02</td></tr>
<tr><td>2020-10-29</td><td>ARKK</td><td>TSLA</td><td>14244</td><td>410.83</td></tr>
<tr><td>2020-11-02</td><td>ARKK</td><td>TSLA</td><td>3561</td><td>400.51</td></tr>
<tr><td>2020-11-03</td><td>ARKK</td><td>TSLA</td><td>-151615</td><td>423.9</td></tr>
</tbody></table>
<p>Total 88459 rows</p>
<h3>Holdings</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">account_id</th><th class="text-right">d</th><th class="text-right">ticker</th><th class="text-right">qty</th></thead><tbody>
<tr><td>ARKK</td><td>2020-09-30</td><td>TSLA</td><td>0</td></tr>
<tr><td>ARKK</td><td>2020-12-31</td><td>TSLA</td><td>2660439</td></tr>
<tr><td>ARKK</td><td>2021-03-31</td><td>TSLA</td><td>3757949</td></tr>
<tr><td>ARKK</td><td>2021-06-30</td><td>TSLA</td><td>3566520</td></tr>
<tr><td>ARKK</td><td>2021-09-30</td><td>TSLA</td><td>2545118</td></tr>
<tr><td>ARKK</td><td>2021-12-31</td><td>TSLA</td><td>1198876</td></tr>
<tr><td>ARKK</td><td>2022-03-31</td><td>TSLA</td><td>1094098</td></tr>
<tr><td>ARKK</td><td>2022-06-30</td><td>TSLA</td><td>1023093</td></tr>
<tr><td>ARKK</td><td>2022-09-30</td><td>TSLA</td><td>2927507</td></tr>
<tr><td>ARKK</td><td>2022-12-31</td><td>TSLA</td><td>0</td></tr>
</tbody></table>
<p>Total 4300 rows</p>
</div>
<div class="row">
<h2>1_read_txns</h2>
<h3>Script node 1_read_txns:</h3>
<pre id="json">{
  "1_read_txns": {
    "type": "file_table",
    "desc": "Load txns from csv",
    "explicit_run_only": true,
    "r": {
      "urls": [
        "{dir_in}/txns.csv"
      ],
      "csv": {
        "hdr_line_idx": 0,
        "first_data_line_idx": 1
      },
      "columns": {
        "col_ts": {
          "csv": {
            "col_hdr": "ts"
          },
          "col_type": "string"
        },
        "col_account_id": {
          "csv": {
            "col_hdr": "account_id"
          },
          "col_type": "string"
        },
        "col_ticker": {
          "csv": {
            "col_hdr": "ticker"
          },
          "col_type": "string"
        },
        "col_qty": {
          "csv": {
            "col_hdr": "qty",
            "col_format": "%d"
          },
          "col_type": "int"
        },
        "col_price": {
          "csv": {
            "col_hdr": "price",
            "col_format": "%f"
          },
          "col_type": "float"
        }
      }
    },
    "w": {
      "name": "txns",
      "having": "w.ts > \"{period_start_eod}\" && w.ts <= \"{period_end_eod}\"",
      "fields": {
        "account_id": {
          "expression": "r.col_account_id",
          "type": "string"
        },
        "ts": {
          "expression": "r.col_ts",
          "type": "string"
        },
        "txn_json": {
          "expression": "strings.ReplaceAll(fmt.Sprintf(`{'ts':'%s','t':'%s','q':%d,'p':%s}`, r.col_ts, r.col_ticker, r.col_qty, decimal2(r.col_price)), `'`,`\"`)",
          "type": "string"
        }
      },
      "indexes": {
        "idx_txns_account_id": "non_unique(account_id)"
      }
    }
  }
}</pre>
<h3>Script node 1_read_txns produces Cassandra table txns:</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">rowid</th><th class="text-right">account_id</th><th class="text-right">batch_idx</th><th class="text-right">ts</th><th class="text-right">txn_json</th></thead><tbody>
<tr><td>6094664611844062359</td><td>ARKW</td><td>0</td><td>2021-04-14</td><td>{"ts":"2021-04-14","t":"FSLY","q":1532,"p":71.92}</td></tr>
<tr><td>8537883289672171463</td><td>ARKF</td><td>0</td><td>2022-02-03</td><td>{"ts":"2022-02-03","t":"SNAP","q":-933,"p":24.5}</td></tr>
<tr><td>2749076004491469954</td><td>ARKQ</td><td>0</td><td>2021-11-12</td><td>{"ts":"2021-11-12","t":"BIDU","q":-368,"p":170.57}</td></tr>
<tr><td>7445773725017646389</td><td>ARKK</td><td>0</td><td>2021-05-07</td><td>{"ts":"2021-05-07","t":"TWLO","q":37128,"p":307.15}</td></tr>
<tr><td>8993784235489443377</td><td>ARKK</td><td>0</td><td>2021-11-12</td><td>{"ts":"2021-11-12","t":"SKLZ","q":-26172,"p":12.5}</td></tr>
<tr><td>206487046063108640</td><td>ARKW</td><td>0</td><td>2022-09-20</td><td>{"ts":"2022-09-20","t":"NNDM","q":-3,"p":2.45}</td></tr>
<tr><td>3354548830737968360</td><td>ARKG</td><td>0</td><td>2022-10-20</td><td>{"ts":"2022-10-20","t":"ONVO","q":896,"p":1.71}</td></tr>
<tr><td>8851154163572220846</td><td>ARKQ</td><td>0</td><td>2022-10-28</td><td>{"ts":"2022-10-28","t":"AVAV","q":-1166,"p":90.14}</td></tr>
<tr><td>151913958205174664</td><td>ARKG</td><td>0</td><td>2021-05-04</td><td>{"ts":"2021-05-04","t":"GH","q":-7216,"p":148.19}</td></tr>
<tr><td>8571157745347545844</td><td>ARKK</td><td>0</td><td>2021-12-29</td><td>{"ts":"2021-12-29","t":"HOOD","q":-43488,"p":17.11}</td></tr>
</tbody></table>
<p>Total 79487 rows</p>
</div>
<div class="row">
<h2>1_read_accounts</h2>
<h3>Script node 1_read_accounts:</h3>
<pre id="json">{
  "1_read_accounts": {
    "type": "file_table",
    "desc": "Load accounts from csv",
    "explicit_run_only": true,
    "r": {
      "urls": [
        "{dir_in}/accounts.csv"
      ],
      "csv": {
        "hdr_line_idx": 0,
        "first_data_line_idx": 1
      },
      "columns": {
        "col_account_id": {
          "csv": {
            "col_hdr": "account_id"
          },
          "col_type": "string"
        },
        "col_earliest_period_start": {
          "csv": {
            "col_hdr": "earliest_period_start"
          },
          "col_type": "string"
        }
      }
    },
    "w": {
      "name": "accounts",
      "having": "w.earliest_period_start <= \"{period_start_eod}\"",
      "fields": {
        "account_id": {
          "expression": "r.col_account_id",
          "type": "string"
        },
        "earliest_period_start": {
          "expression": "r.col_earliest_period_start",
          "type": "string"
        }
      }
    }
  }
}</pre>
<h3>Script node 1_read_accounts produces Cassandra table accounts:</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">rowid</th><th class="text-right">account_id</th><th class="text-right">batch_idx</th><th class="text-right">earliest_period_start</th></thead><tbody>
<tr><td>748401470040242660</td><td>ARKK</td><td>0</td><td>2020-12-31</td></tr>
<tr><td>6621936461880082804</td><td>ARKF</td><td>0</td><td>2020-12-31</td></tr>
<tr><td>1522209384545663127</td><td>ARKW</td><td>0</td><td>2020-12-31</td></tr>
<tr><td>2380715082357295080</td><td>ARKG</td><td>0</td><td>2020-12-31</td></tr>
<tr><td>5559895917703115577</td><td>ARKQ</td><td>0</td><td>2020-12-31</td></tr>
<tr><td>6520205207003275793</td><td>ARKX</td><td>0</td><td>2020-12-31</td></tr>
</tbody></table>
<p>Total 6 rows</p>
</div>
<div class="row">
<h2>1_read_period_holdings</h2>
<h3>Script node 1_read_period_holdings:</h3>
<pre id="json">{
  "1_read_period_holdings": {
    "type": "file_table",
    "desc": "Load holdings from csv",
    "explicit_run_only": true,
    "r": {
      "urls": [
        "{dir_in}/holdings.csv"
      ],
      "csv": {
        "hdr_line_idx": 0,
        "first_data_line_idx": 1
      },
      "columns": {
        "col_eod": {
          "csv": {
            "col_hdr": "d"
          },
          "col_type": "string"
        },
        "col_account_id": {
          "csv": {
            "col_hdr": "account_id"
          },
          "col_type": "string"
        },
        "col_ticker": {
          "csv": {
            "col_hdr": "ticker"
          },
          "col_type": "string"
        },
        "col_qty": {
          "csv": {
            "col_hdr": "qty",
            "col_format": "%d"
          },
          "col_type": "int"
        }
      }
    },
    "w": {
      "name": "period_holdings",
      "having": "\"{period_start_eod}\" <= w.eod && w.eod <= \"{period_end_eod}\"",
      "fields": {
        "account_id": {
          "expression": "r.col_account_id",
          "type": "string"
        },
        "eod": {
          "expression": "r.col_eod",
          "type": "string"
        },
        "holding_json": {
          "expression": "fmt.Sprintf(`{\"d\":\"%s\",\"t\":\"%s\",\"q\":%d}`, r.col_eod, r.col_ticker, r.col_qty)",
          "type": "string"
        }
      },
      "indexes": {
        "idx_period_holdings_account_id": "non_unique(account_id)"
      }
    }
  }
}</pre>
<h3>Script node 1_read_period_holdings produces Cassandra table period_holdings:</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">rowid</th><th class="text-right">account_id</th><th class="text-right">batch_idx</th><th class="text-right">eod</th><th class="text-right">holding_json</th></thead><tbody>
<tr><td>523927006809746992</td><td>ARKW</td><td>0</td><td>2022-03-31</td><td>{"d":"2022-03-31","t":"PLTR","q":50}</td></tr>
<tr><td>7964715912605789246</td><td>ARKW</td><td>0</td><td>2022-06-30</td><td>{"d":"2022-06-30","t":"VCYT","q":962271}</td></tr>
<tr><td>7321126894636851304</td><td>ARKK</td><td>0</td><td>2022-03-31</td><td>{"d":"2022-03-31","t":"IRDM","q":913}</td></tr>
<tr><td>159541754259824109</td><td>ARKK</td><td>0</td><td>2021-06-30</td><td>{"d":"2021-06-30","t":"PACB","q":6470871}</td></tr>
<tr><td>3147847123612473758</td><td>ARKG</td><td>0</td><td>2021-06-30</td><td>{"d":"2021-06-30","t":"TXG","q":1114540}</td></tr>
<tr><td>6088195109262281354</td><td>ARKW</td><td>0</td><td>2021-03-31</td><td>{"d":"2021-03-31","t":"SNAP","q":1293117}</td></tr>
<tr><td>3371442508833222747</td><td>ARKQ</td><td>0</td><td>2021-06-30</td><td>{"d":"2021-06-30","t":"ADSK","q":119}</td></tr>
<tr><td>8119438770895972412</td><td>ARKF</td><td>0</td><td>2022-12-31</td><td>{"d":"2022-12-31","t":"3690","q":0}</td></tr>
<tr><td>760021395079726942</td><td>ARKF</td><td>0</td><td>2021-12-31</td><td>{"d":"2021-12-31","t":"6060","q":6081}</td></tr>
<tr><td>464401136269549803</td><td>ARKG</td><td>0</td><td>2022-12-31</td><td>{"d":"2022-12-31","t":"SYRS","q":0}</td></tr>
</tbody></table>
<p>Total 3914 rows</p>
</div>
<div class="row">
<h2>2_account_txns_outer</h2>
<h3>Script node 2_account_txns_outer:</h3>
<pre id="json">{
  "2_account_txns_outer": {
    "type": "table_lookup_table",
    "desc": "For each account, merge all txns into single json string",
    "r": {
      "table": "accounts",
      "expected_batches_total": 10
    },
    "l": {
      "index_name": "idx_txns_account_id",
      "join_on": "r.account_id",
      "group": true,
      "join_type": "left"
    },
    "w": {
      "name": "account_txns",
      "fields": {
        "account_id": {
          "expression": "r.account_id",
          "type": "string"
        },
        "txns_json": {
          "expression": "string_agg(l.txn_json,\",\")",
          "type": "string"
        }
      }
    }
  }
}</pre>
<h3>Script node 2_account_txns_outer produces Cassandra table account_txns:</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">rowid</th><th class="text-right">account_id</th><th class="text-right">batch_idx</th><th class="text-right">txns_json</th></thead><tbody>
<tr><td>7337640464596222089</td><td>ARKX</td><td>6</td><td>{"ts":"2021-04-23","t":"AIR","q":-286,"p":119.13},{"ts":"2021-07-20","t":"AVAV","q":8887,"p":96.85}, ... total length 181595</td></tr>
<tr><td>3719903644314909584</td><td>ARKF</td><td>5</td><td>{"ts":"2022-02-04","t":"Z","q":-2835,"p":48.94},{"ts":"2022-12-31","t":"IPOB","q":-872035,"p":29.5}, ... total length 481037</td></tr>
<tr><td>7773052335557492403</td><td>ARKG</td><td>5</td><td>{"ts":"2022-05-10","t":"PSNL","q":86800,"p":4.4},{"ts":"2022-01-21","t":"IOVA","q":-15248,"p":13.96} ... total length 1084244</td></tr>
<tr><td>2948673979393982941</td><td>ARKW</td><td>5</td><td>{"ts":"2021-05-28","t":"NFLX","q":-465,"p":502.81},{"ts":"2021-04-30","t":"PYPL","q":-34800,"p":262. ... total length 714787</td></tr>
<tr><td>4577965328217475423</td><td>ARKK</td><td>0</td><td>{"ts":"2021-03-04","t":"SQ","q":266809,"p":218.41},{"ts":"2021-03-11","t":"SQ","q":120492,"p":241.72 ... total length 1011871</td></tr>
<tr><td>6410928427592534468</td><td>ARKQ</td><td>3</td><td>{"ts":"2022-06-15","t":"AVAV","q":-38717,"p":83.61},{"ts":"2022-05-11","t":"SNPS","q":-117,"p":260.8 ... total length 563105</td></tr>
</tbody></table>
<p>Total 6 rows</p>
</div>
<div class="row">
<h2>2_account_period_holdings_outer</h2>
<h3>Script node 2_account_period_holdings_outer:</h3>
<pre id="json">{
  "2_account_period_holdings_outer": {
    "type": "table_lookup_table",
    "desc": "For each account, merge all holdings into single json string",
    "r": {
      "table": "accounts",
      "expected_batches_total": 10
    },
    "l": {
      "index_name": "idx_period_holdings_account_id",
      "join_on": "r.account_id",
      "group": true,
      "join_type": "left"
    },
    "w": {
      "name": "account_period_holdings",
      "fields": {
        "account_id": {
          "expression": "r.account_id",
          "type": "string"
        },
        "holdings_json": {
          "expression": "string_agg(l.holding_json,\",\")",
          "type": "string"
        }
      },
      "indexes": {
        "idx_account_period_holdings_account_id": "unique(account_id)"
      }
    }
  }
}</pre>
<h3>Script node 2_account_period_holdings_outer produces Cassandra table account_period_holdings:</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">rowid</th><th class="text-right">account_id</th><th class="text-right">batch_idx</th><th class="text-right">holdings_json</th></thead><tbody>
<tr><td>3798263933557717806</td><td>ARKF</td><td>5</td><td>{"d":"2022-06-30","t":"ROKU","q":0},{"d":"2022-06-30","t":"BABA","q":200},{"d":"2021-06-30","t":"HDB ... total length 25305</td></tr>
<tr><td>2297870030956086858</td><td>ARKK</td><td>0</td><td>{"d":"2022-12-31","t":"PATH","q":0},{"d":"2022-12-31","t":"MTLS","q":0},{"d":"2021-03-31","t":"COIN" ... total length 28246</td></tr>
<tr><td>6490459023829990771</td><td>ARKX</td><td>6</td><td>{"d":"2021-06-30","t":"XLNX","q":17088},{"d":"2022-03-31","t":"GOOG","q":2899},{"d":"2021-06-30","t" ... total length 17095</td></tr>
<tr><td>7126461419439144862</td><td>ARKW</td><td>5</td><td>{"d":"2022-03-31","t":"FTCH","q":101},{"d":"2021-06-30","t":"JD","q":1452974},{"d":"2022-03-31","t": ... total length 29139</td></tr>
<tr><td>5291018643877674808</td><td>ARKQ</td><td>3</td><td>{"d":"2021-12-31","t":"ROK","q":1248},{"d":"2022-12-31","t":"WKHS","q":0},{"d":"2022-06-30","t":"ISR ... total length 23268</td></tr>
<tr><td>3073048863807356155</td><td>ARKG</td><td>5</td><td>{"d":"2022-03-31","t":"CLLS","q":606},{"d":"2021-03-31","t":"PRME","q":0},{"d":"2020-12-31","t":"PHR ... total length 30734</td></tr>
</tbody></table>
<p>Total 6 rows</p>
</div>
<div class="row">
<h2>3_build_account_period_activity</h2>
<h3>Script node 3_build_account_period_activity:</h3>
<pre id="json">{
  "3_build_account_period_activity": {
    "type": "table_lookup_table",
    "desc": "For each account, merge holdings and txns",
    "r": {
      "table": "account_txns",
      "expected_batches_total": 10
    },
    "l": {
      "index_name": "idx_account_period_holdings_account_id",
      "join_on": "r.account_id",
      "group": false,
      "join_type": "left"
    },
    "w": {
      "name": "account_period_activity",
      "fields": {
        "account_id": {
          "expression": "r.account_id",
          "type": "string"
        },
        "txns_json": {
          "expression": " \"[\" + r.txns_json + \"]\" ",
          "type": "string"
        },
        "holdings_json": {
          "expression": " \"[\" + l.holdings_json + \"]\" ",
          "type": "string"
        }
      }
    }
  }
}</pre>
<h3>Script node 3_build_account_period_activity produces Cassandra table account_period_activity:</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">rowid</th><th class="text-right">account_id</th><th class="text-right">batch_idx</th><th class="text-right">holdings_json</th><th class="text-right">txns_json</th></thead><tbody>
<tr><td>2832510643465443886</td><td>ARKW</td><td>6</td><td>[{"d":"2022-03-31","t":"FTCH","q":101},{"d":"2021-06-30","t":"JD","q":1452974},{"d":"2022-03-31","t" ... total length 29141</td><td>[{"ts":"2021-05-28","t":"NFLX","q":-465,"p":502.81},{"ts":"2021-04-30","t":"PYPL","q":-34800,"p":262 ... total length 714789</td></tr>
<tr><td>8724188995369700700</td><td>ARKQ</td><td>9</td><td>[{"d":"2021-12-31","t":"ROK","q":1248},{"d":"2022-12-31","t":"WKHS","q":0},{"d":"2022-06-30","t":"IS ... total length 23270</td><td>[{"ts":"2022-06-15","t":"AVAV","q":-38717,"p":83.61},{"ts":"2022-05-11","t":"SNPS","q":-117,"p":260. ... total length 563107</td></tr>
<tr><td>3797016840160679147</td><td>ARKX</td><td>1</td><td>[{"d":"2021-06-30","t":"XLNX","q":17088},{"d":"2022-03-31","t":"GOOG","q":2899},{"d":"2021-06-30","t ... total length 17097</td><td>[{"ts":"2021-04-23","t":"AIR","q":-286,"p":119.13},{"ts":"2021-07-20","t":"AVAV","q":8887,"p":96.85} ... total length 181597</td></tr>
<tr><td>6149240839756633886</td><td>ARKK</td><td>4</td><td>[{"d":"2022-12-31","t":"PATH","q":0},{"d":"2022-12-31","t":"MTLS","q":0},{"d":"2021-03-31","t":"COIN ... total length 28248</td><td>[{"ts":"2021-03-04","t":"SQ","q":266809,"p":218.41},{"ts":"2021-03-11","t":"SQ","q":120492,"p":241.7 ... total length 1011873</td></tr>
<tr><td>1335953350070866378</td><td>ARKF</td><td>2</td><td>[{"d":"2022-06-30","t":"ROKU","q":0},{"d":"2022-06-30","t":"BABA","q":200},{"d":"2021-06-30","t":"HD ... total length 25307</td><td>[{"ts":"2022-02-04","t":"Z","q":-2835,"p":48.94},{"ts":"2022-12-31","t":"IPOB","q":-872035,"p":29.5} ... total length 481039</td></tr>
<tr><td>1945457872909272069</td><td>ARKG</td><td>8</td><td>[{"d":"2022-03-31","t":"CLLS","q":606},{"d":"2021-03-31","t":"PRME","q":0},{"d":"2020-12-31","t":"PH ... total length 30736</td><td>[{"ts":"2022-05-10","t":"PSNL","q":86800,"p":4.4},{"ts":"2022-01-21","t":"IOVA","q":-15248,"p":13.96 ... total length 1084246</td></tr>
</tbody></table>
<p>Total 6 rows</p>
</div>
<div class="row">
<h2>4_calc_account_period_perf</h2>
<h3>Script node 4_calc_account_period_perf:</h3>
<pre id="json">{
  "4_calc_account_period_perf": {
    "type": "table_custom_tfm_table",
    "custom_proc_type": "py_calc",
    "desc": "Apply Python-based calculations to account holdings and txns",
    "r": {
      "table": "account_period_activity",
      "expected_batches_total": 10
    },
    "p": {
      "python_code_urls": [
        "{dir_py}/portfolio_test_company_info_provider.py",
        "{dir_py}/portfolio_test_eod_price_provider.py",
        "{dir_py}/portfolio_calc.py"
      ],
      "calculated_fields": {
        "perf_json": {
          "expression": "txns_and_holdings_to_twr_cagr_by_sector_year_quarter_json(\"{period_start_eod}\", \"{period_end_eod}\", r.holdings_json, r.txns_json, PortfolioTestEodPriceProvider, PortfolioTestCompanyInfoProvider)",
          "type": "string"
        }
      }
    },
    "w": {
      "name": "account_period_perf",
      "fields": {
        "account_id": {
          "expression": "r.account_id",
          "type": "string"
        },
        "perf_json": {
          "expression": "p.perf_json",
          "type": "string"
        }
      }
    }
  }
}</pre>
<h3>Script node 4_calc_account_period_perf produces Cassandra table account_period_perf:</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">rowid</th><th class="text-right">account_id</th><th class="text-right">batch_idx</th><th class="text-right">perf_json</th></thead><tbody>
<tr><td>6887364451659257268</td><td>ARKF</td><td>6</td><td>{"2021": {"All": {"cagr": -0.1912, "twr": -0.1912}, "Communication Services": {"cagr": -0.4067, "twr ... total length 4679</td></tr>
<tr><td>5754198081589614465</td><td>ARKK</td><td>6</td><td>{"2021": {"All": {"cagr": -0.2398, "twr": -0.2398}, "Communication Services": {"cagr": -0.3183, "twr ... total length 4731</td></tr>
<tr><td>32049402890064872</td><td>ARKW</td><td>3</td><td>{"2021": {"All": {"cagr": -0.1949, "twr": -0.1949}, "Communication Services": {"cagr": -0.293, "twr" ... total length 4758</td></tr>
<tr><td>4248855088935145245</td><td>ARKQ</td><td>9</td><td>{"2021": {"All": {"cagr": -0.0152, "twr": -0.0152}, "Communication Services": {"cagr": 0.062, "twr": ... total length 4674</td></tr>
<tr><td>8662263145276984767</td><td>ARKX</td><td>9</td><td>{"2021": {"All": {"cagr": -0.1055, "twr": -0.1055}, "Communication Services": {"cagr": 0.1719, "twr" ... total length 4544</td></tr>
<tr><td>1210483319197080237</td><td>ARKG</td><td>5</td><td>{"2021": {"All": {"cagr": -0.3384, "twr": -0.3384}, "Communication Services": {"cagr": 0.1666, "twr" ... total length 4533</td></tr>
</tbody></table>
<p>Total 6 rows</p>
</div>
<div class="row">
<h2>5_tag_by_period</h2>
<h3>Script node 5_tag_by_period:</h3>
<pre id="json">{
  "5_tag_by_period": {
    "type": "table_custom_tfm_table",
    "custom_proc_type": "tag_and_denormalize",
    "desc": "Tag accounts by period name",
    "r": {
      "table": "account_period_perf",
      "expected_batches_total": 10
    },
    "p": {
      "tag_field_name": "period",
      "tag_criteria": {
        "2021": "re.MatchString(`\"2021\":`, r.perf_json)",
        "2021Q1": "re.MatchString(`\"2021Q1\":`, r.perf_json)",
        "2021Q2": "re.MatchString(`\"2021Q2\":`, r.perf_json)",
        "2021Q3": "re.MatchString(`\"2021Q3\":`, r.perf_json)",
        "2021Q4": "re.MatchString(`\"2021Q4\":`, r.perf_json)",
        "2022": "re.MatchString(`\"2022\":`, r.perf_json)",
        "2022Q1": "re.MatchString(`\"2022Q1\":`, r.perf_json)",
        "2022Q2": "re.MatchString(`\"2022Q2\":`, r.perf_json)",
        "2022Q3": "re.MatchString(`\"2022Q3\":`, r.perf_json)",
        "2022Q4": "re.MatchString(`\"2022Q4\":`, r.perf_json)"
      }
    },
    "w": {
      "name": "account_period_perf_by_period",
      "fields": {
        "period": {
          "expression": "p.period",
          "type": "string"
        },
        "account_id": {
          "expression": "r.account_id",
          "type": "string"
        },
        "perf_json": {
          "expression": "r.perf_json",
          "type": "string"
        }
      }
    }
  }
}</pre>
<h3>Script node 5_tag_by_period produces Cassandra table account_period_perf_by_period:</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">rowid</th><th class="text-right">account_id</th><th class="text-right">batch_idx</th><th class="text-right">perf_json</th><th class="text-right">period</th></thead><tbody>
<tr><td>3812613906073144497</td><td>ARKK</td><td>7</td><td>{"2021": {"All": {"cagr": -0.2398, "twr": -0.2398}, "Communication Services": {"cagr": -0.3183, "twr ... total length 4731</td><td>2022Q4</td></tr>
<tr><td>7276369387634914856</td><td>ARKX</td><td>4</td><td>{"2021": {"All": {"cagr": -0.1055, "twr": -0.1055}, "Communication Services": {"cagr": 0.1719, "twr" ... total length 4544</td><td>2021Q3</td></tr>
<tr><td>6738115215161291018</td><td>ARKW</td><td>0</td><td>{"2021": {"All": {"cagr": -0.1949, "twr": -0.1949}, "Communication Services": {"cagr": -0.293, "twr" ... total length 4758</td><td>2022Q2</td></tr>
<tr><td>7605309852895153944</td><td>ARKG</td><td>6</td><td>{"2021": {"All": {"cagr": -0.3384, "twr": -0.3384}, "Communication Services": {"cagr": 0.1666, "twr" ... total length 4533</td><td>2021Q1</td></tr>
<tr><td>1922480560878025461</td><td>ARKF</td><td>2</td><td>{"2021": {"All": {"cagr": -0.1912, "twr": -0.1912}, "Communication Services": {"cagr": -0.4067, "twr ... total length 4679</td><td>2022Q3</td></tr>
<tr><td>7092756260584728207</td><td>ARKK</td><td>7</td><td>{"2021": {"All": {"cagr": -0.2398, "twr": -0.2398}, "Communication Services": {"cagr": -0.3183, "twr ... total length 4731</td><td>2021</td></tr>
<tr><td>4467122228499360750</td><td>ARKG</td><td>6</td><td>{"2021": {"All": {"cagr": -0.3384, "twr": -0.3384}, "Communication Services": {"cagr": 0.1666, "twr" ... total length 4533</td><td>2021</td></tr>
<tr><td>6162316215288009881</td><td>ARKX</td><td>4</td><td>{"2021": {"All": {"cagr": -0.1055, "twr": -0.1055}, "Communication Services": {"cagr": 0.1719, "twr" ... total length 4544</td><td>2021Q2</td></tr>
<tr><td>1759821806393733334</td><td>ARKF</td><td>2</td><td>{"2021": {"All": {"cagr": -0.1912, "twr": -0.1912}, "Communication Services": {"cagr": -0.4067, "twr ... total length 4679</td><td>2021Q2</td></tr>
<tr><td>3848238608544572988</td><td>ARKW</td><td>0</td><td>{"2021": {"All": {"cagr": -0.1949, "twr": -0.1949}, "Communication Services": {"cagr": -0.293, "twr" ... total length 4758</td><td>2022Q4</td></tr>
</tbody></table>
<p>Total 60 rows</p>
</div>
<div class="row">
<h2>5_tag_by_sector</h2>
<h3>Script node 5_tag_by_sector:</h3>
<pre id="json">{
  "5_tag_by_sector": {
    "type": "table_custom_tfm_table",
    "custom_proc_type": "tag_and_denormalize",
    "desc": "Tag accounts by sector",
    "r": {
      "table": "account_period_perf_by_period",
      "expected_batches_total": 10
    },
    "p": {
      "tag_field_name": "sector",
      "tag_criteria": {
        "All": "re.MatchString(`\"All\":`, r.perf_json)",
        "Communication Services": "re.MatchString(`\"Communication Services\":`, r.perf_json)",
        "Consumer Cyclical": "re.MatchString(`\"Consumer Cyclical\":`, r.perf_json)",
        "Consumer Defensive": "re.MatchString(`\"Consumer Defensive\":`, r.perf_json)",
        "Financial Services": "re.MatchString(`\"Financial Services\":`, r.perf_json)",
        "Healthcare": "re.MatchString(`\"Healthcare\":`, r.perf_json)",
        "Industrials": "re.MatchString(`\"Industrials\":`, r.perf_json)",
        "Real Estate": "re.MatchString(`\"Real Estate\":`, r.perf_json)",
        "Technology": "re.MatchString(`\"Technology\":`, r.perf_json)"
      }
    },
    "w": {
      "name": "account_period_perf_by_period_sector",
      "fields": {
        "period": {
          "expression": "r.period",
          "type": "string"
        },
        "sector": {
          "expression": "p.sector",
          "type": "string"
        },
        "account_id": {
          "expression": "r.account_id",
          "type": "string"
        },
        "perf_json": {
          "expression": "r.perf_json",
          "type": "string"
        }
      }
    }
  }
}</pre>
<h3>Script node 5_tag_by_sector produces Cassandra table account_period_perf_by_period_sector:</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">rowid</th><th class="text-right">account_id</th><th class="text-right">batch_idx</th><th class="text-right">perf_json</th><th class="text-right">period</th><th class="text-right">sector</th></thead><tbody>
<tr><td>4880353688536716330</td><td>ARKX</td><td>7</td><td>{"2021": {"All": {"cagr": -0.1055, "twr": -0.1055}, "Communication Services": {"cagr": 0.1719, "twr" ... total length 4544</td><td>2022Q3</td><td>All</td></tr>
<tr><td>5966907642021688353</td><td>ARKG</td><td>2</td><td>{"2021": {"All": {"cagr": -0.3384, "twr": -0.3384}, "Communication Services": {"cagr": 0.1666, "twr" ... total length 4533</td><td>2021Q2</td><td>Communication Services</td></tr>
<tr><td>216345607086265348</td><td>ARKW</td><td>5</td><td>{"2021": {"All": {"cagr": -0.1949, "twr": -0.1949}, "Communication Services": {"cagr": -0.293, "twr" ... total length 4758</td><td>2021Q3</td><td>Financial Services</td></tr>
<tr><td>444465478572115389</td><td>ARKW</td><td>9</td><td>{"2021": {"All": {"cagr": -0.1949, "twr": -0.1949}, "Communication Services": {"cagr": -0.293, "twr" ... total length 4758</td><td>2022Q1</td><td>Industrials</td></tr>
<tr><td>4655715813499361957</td><td>ARKK</td><td>9</td><td>{"2021": {"All": {"cagr": -0.2398, "twr": -0.2398}, "Communication Services": {"cagr": -0.3183, "twr ... total length 4731</td><td>2022Q1</td><td>Financial Services</td></tr>
<tr><td>3105771363861377355</td><td>ARKQ</td><td>6</td><td>{"2021": {"All": {"cagr": -0.0152, "twr": -0.0152}, "Communication Services": {"cagr": 0.062, "twr": ... total length 4674</td><td>2021Q1</td><td>Consumer Defensive</td></tr>
<tr><td>1473264958443625609</td><td>ARKK</td><td>2</td><td>{"2021": {"All": {"cagr": -0.2398, "twr": -0.2398}, "Communication Services": {"cagr": -0.3183, "twr ... total length 4731</td><td>2022Q4</td><td>Technology</td></tr>
<tr><td>4441230069590019727</td><td>ARKX</td><td>0</td><td>{"2021": {"All": {"cagr": -0.1055, "twr": -0.1055}, "Communication Services": {"cagr": 0.1719, "twr" ... total length 4544</td><td>2021Q2</td><td>Communication Services</td></tr>
<tr><td>347198857808667031</td><td>ARKG</td><td>3</td><td>{"2021": {"All": {"cagr": -0.3384, "twr": -0.3384}, "Communication Services": {"cagr": 0.1666, "twr" ... total length 4533</td><td>2022Q3</td><td>All</td></tr>
<tr><td>5194216653932103424</td><td>ARKK</td><td>5</td><td>{"2021": {"All": {"cagr": -0.2398, "twr": -0.2398}, "Communication Services": {"cagr": -0.3183, "twr ... total length 4731</td><td>2022Q2</td><td>Healthcare</td></tr>
</tbody></table>
<p>Total 540 rows</p>
</div>
<div class="row">
<h2>6_perf_json_to_columns</h2>
<h3>Script node 6_perf_json_to_columns:</h3>
<pre id="json">{
  "6_perf_json_to_columns": {
    "type": "table_custom_tfm_table",
    "custom_proc_type": "py_calc",
    "desc": "Use Python to read perf json and save stats as columns",
    "r": {
      "table": "account_period_perf_by_period_sector",
      "expected_batches_total": 100
    },
    "p": {
      "python_code_urls": [
        "{dir_py}/json_to_columns.py"
      ],
      "calculated_fields": {
        "twr": {
          "expression": "json_to_twr(r.perf_json, r.period, r.sector)",
          "type": "float"
        },
        "cagr": {
          "expression": "json_to_cagr(r.perf_json, r.period, r.sector)",
          "type": "float"
        }
      }
    },
    "w": {
      "name": "account_period_sector_twr_cagr",
      "fields": {
        "account_id": {
          "expression": "r.account_id",
          "type": "string"
        },
        "period": {
          "expression": "r.period",
          "type": "string"
        },
        "sector": {
          "expression": "r.sector",
          "type": "string"
        },
        "twr": {
          "expression": "p.twr",
          "type": "float"
        },
        "cagr": {
          "expression": "p.cagr",
          "type": "float"
        }
      }
    }
  }
}</pre>
<h3>Script node 6_perf_json_to_columns produces Cassandra table account_period_sector_twr_cagr:</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">rowid</th><th class="text-right">account_id</th><th class="text-right">batch_idx</th><th class="text-right">cagr</th><th class="text-right">period</th><th class="text-right">sector</th><th class="text-right">twr</th></thead><tbody>
<tr><td>2051940333335580608</td><td>ARKF</td><td>30</td><td>-42.3</td><td>2022Q4</td><td>Communication Services</td><td>-12.94</td></tr>
<tr><td>467099065024923780</td><td>ARKG</td><td>16</td><td>-66.06</td><td>2022Q1</td><td>All</td><td>-23.39</td></tr>
<tr><td>4793009141456092103</td><td>ARKK</td><td>42</td><td>-85.25</td><td>2022Q2</td><td>Communication Services</td><td>-37.95</td></tr>
<tr><td>1668642860725665609</td><td>ARKG</td><td>50</td><td>-2.49</td><td>2022Q2</td><td>Communication Services</td><td>-0.63</td></tr>
<tr><td>4172230767046282068</td><td>ARKF</td><td>63</td><td>-69.22</td><td>2021Q4</td><td>Communication Services</td><td>-25.69</td></tr>
<tr><td>3320490046305540588</td><td>ARKQ</td><td>91</td><td>-32.86</td><td>2021Q1</td><td>Healthcare</td><td>-9.36</td></tr>
<tr><td>6384236349569128686</td><td>ARKW</td><td>37</td><td>22.25</td><td>2022Q4</td><td>Healthcare</td><td>5.19</td></tr>
<tr><td>3902626804003825458</td><td>ARKG</td><td>32</td><td>-1.75</td><td>2022Q2</td><td>Financial Services</td><td>-0.44</td></tr>
<tr><td>2059833829580478020</td><td>ARKQ</td><td>37</td><td>1.73</td><td>2021</td><td>Technology</td><td>1.73</td></tr>
<tr><td>4830284743586419631</td><td>ARKQ</td><td>12</td><td>-73.12</td><td>2022Q3</td><td>Consumer Cyclical</td><td>-28.19</td></tr>
</tbody></table>
<p>Total 540 rows</p>
</div>
<div class="row">
<h2>7_file_account_period_sector_perf</h2>
<h3>Script node 7_file_account_period_sector_perf:</h3>
<pre id="json">{
  "7_file_account_period_sector_perf": {
    "type": "table_file",
    "desc": "Write yearly/quarterly perf results by sector to CSV file",
    "r": {
      "table": "account_period_sector_twr_cagr"
    },
    "w": {
      "top": {
        "order": "account_id,period,sector"
      },
      "url_template": "{dir_out}/account_period_sector_perf.csv",
      "columns": [
        {
          "csv": {
            "header": "ARK fund",
            "format": "%s"
          },
          "name": "account_id",
          "expression": "r.account_id",
          "type": "string"
        },
        {
          "csv": {
            "header": "Period",
            "format": "%s"
          },
          "name": "period",
          "expression": "r.period",
          "type": "string"
        },
        {
          "csv": {
            "header": "Sector",
            "format": "%s"
          },
          "name": "sector",
          "expression": "r.sector",
          "type": "string"
        },
        {
          "csv": {
            "header": "Time-weighted annualized return %",
            "format": "%.2f"
          },
          "name": "cagr",
          "expression": "r.cagr",
          "type": "float"
        }
      ]
    }
  }
}</pre>
<h3>Script node 7_file_account_period_sector_perf produces data file:</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">ARK fund</th><th class="text-right">Period</th><th class="text-right">Sector</th><th class="text-right">Time-weighted annualized return %</th></thead><tbody>
<tr><td>ARKF</td><td>2021</td><td>All</td><td>-19.12</td></tr>
<tr><td>ARKF</td><td>2021</td><td>Communication Services</td><td>-40.67</td></tr>
<tr><td>ARKF</td><td>2021</td><td>Consumer Cyclical</td><td>-22.28</td></tr>
<tr><td>ARKF</td><td>2021</td><td>Consumer Defensive</td><td>0.00</td></tr>
<tr><td>ARKF</td><td>2021</td><td>Financial Services</td><td>16.53</td></tr>
<tr><td>ARKF</td><td>2021</td><td>Healthcare</td><td>-55.78</td></tr>
<tr><td>ARKF</td><td>2021</td><td>Industrials</td><td>-14.41</td></tr>
<tr><td>ARKF</td><td>2021</td><td>Real Estate</td><td>-44.99</td></tr>
<tr><td>ARKF</td><td>2021</td><td>Technology</td><td>-17.33</td></tr>
<tr><td>ARKF</td><td>2021Q1</td><td>All</td><td>176.50</td></tr>
</tbody></table>
<p>Total 540 rows</p>
</div>
<div class="row">
<h2>7_file_account_year_perf</h2>
<h3>Script node 7_file_account_year_perf:</h3>
<pre id="json">{
  "7_file_account_year_perf": {
    "type": "table_file",
    "desc": "Write yearly perf results for all sectors to CSV file",
    "r": {
      "table": "account_period_sector_twr_cagr"
    },
    "w": {
      "top": {
        "order": "account_id,period"
      },
      "having": "len(w.period) == 4 && w.sector == \"All\"",
      "url_template": "{dir_out}/account_year_perf.csv",
      "columns": [
        {
          "csv": {
            "header": "ARK fund",
            "format": "%s"
          },
          "name": "account_id",
          "expression": "r.account_id",
          "type": "string"
        },
        {
          "csv": {
            "header": "Period",
            "format": "%s"
          },
          "name": "period",
          "expression": "r.period",
          "type": "string"
        },
        {
          "csv": {
            "header": "Sector",
            "format": "%s"
          },
          "name": "sector",
          "expression": "r.sector",
          "type": "string"
        },
        {
          "csv": {
            "header": "Time-weighted annualized return %",
            "format": "%.2f"
          },
          "name": "cagr",
          "expression": "r.cagr",
          "type": "float"
        }
      ]
    }
  }
}</pre>
<h3>Script node 7_file_account_year_perf produces data file:</h3>
<table class="table table-striped text-right" style="font-size:smaller"><thead><th class="text-right">ARK fund</th><th class="text-right">Period</th><th class="text-right">Sector</th><th class="text-right">Time-weighted annualized return %</th></thead><tbody>
<tr><td>ARKF</td><td>2021</td><td>All</td><td>-19.12</td></tr>
<tr><td>ARKF</td><td>2022</td><td>All</td><td>-63.35</td></tr>
<tr><td>ARKG</td><td>2021</td><td>All</td><td>-33.84</td></tr>
<tr><td>ARKG</td><td>2022</td><td>All</td><td>-50.87</td></tr>
<tr><td>ARKK</td><td>2021</td><td>All</td><td>-23.98</td></tr>
<tr><td>ARKK</td><td>2022</td><td>All</td><td>-68.07</td></tr>
<tr><td>ARKQ</td><td>2021</td><td>All</td><td>-1.52</td></tr>
<tr><td>ARKQ</td><td>2022</td><td>All</td><td>-61.45</td></tr>
<tr><td>ARKW</td><td>2021</td><td>All</td><td>-19.49</td></tr>
<tr><td>ARKW</td><td>2022</td><td>All</td><td>-65.28</td></tr>
</tbody></table>
<p>Total 12 rows</p>
</div>
</div></body></head>
